'use strict';

window.slider = function (sliderTag, minValue, maxValue, effectType) {
    var lineEmpty = sliderTag.querySelector('.effect-level__line');
    var depth = sliderTag.querySelector('.effect-level__depth');
    var pin = sliderTag.querySelector('.effect-level__pin');
    var output = sliderTag.querySelector('.effect-level__line');
    var limitMovementX;
    var pinCoord;
    output.value = minValue;

    var movePinHandler = function (evt) {
      limitMovementX = {
        min: 0, // эффект выключен
        max: lineEmpty.offsetLeft + lineEmpty.offsetWidth - pin.offsetWidth
      };
      pinCoord = pin.offsetLeft + evt.movementX;
      if (pinCoord < limitMovementX.min) {
        pinCoord = limitMovementX.min;
      }
      if (pinCoord > limitMovementX.max) {
        pinCoord = limitMovementX.max;
      }

      // Далее идет переключение между расчетом выхода для разных эффектов
      switch (effectType) {
        case 'marvin':
          output.value = Math.round(pinCoord * (maxValue - minValue) / limitMovementX.max);
          pin.style.left = pinCoord + 'px';
          depth.style.width = pinCoord + 'px';
          return;

        case 'sepia':
          output.value = pinCoord * (maxValue - minValue) / limitMovementX.max;

          pin.style.left = pinCoord + 'px';
          depth.style.width = pinCoord + 'px';
          return;
      }
    };

    var pinMouseUpHandler = function () {
      document.removeEventListener('mousemove', movePinHandler);
      document.removeEventListener('mouseup', pinMouseUpHandler);
    };

    pin.addEventListener('mousedown', function () {
      pin.addEventListener('dragstart', window.preventActionHandler);
      document.addEventListener('mousemove', movePinHandler);
      document.addEventListener('mouseup', pinMouseUpHandler);
    });
  };





  
// SCALE.JS
// S.1 Перетягивание изображения во время зума в дополнение к скроллам
var dragImg = function (flag) {
  var imgContainer = document.querySelector('#imgContainer');
  var imgDragged = document.querySelector('#imgContainer-img');
  var leftCord = 0;
  var topCord = 0;
  var xCord = 0;
  var yCord = 0;

  switch (true) {
    case (flag === true):
      imgContainer.onmousedown = function (evt) {
        evt.preventDefault();
        xCord = evt.pageX;
        yCord = evt.pageY;

        var moveAt = function (evtY) {
          imgDragged.style.left = (leftCord + evtY.pageX - xCord) + 'px';
          imgDragged.style.top = (topCord + evtY.pageY - yCord) + 'px';
        };

        imgContainer.onmousemove = function (evtX) {
          moveAt(evtX);
        };

        imgContainer.onmouseleave = imgContainer.onmouseup = function () {
          leftCord = parseFloat(imgDragged.style.left);
          topCord = parseFloat(imgDragged.style.top);
          imgContainer.onmouseleave = null;
          imgContainer.onmousemove = null;
          imgContainer.onmouseup = null;
        };
      };
      return;

    case (flag === false):
      imgContainer.onmousedown = null;
      imgContainer.onmouseleave = null;
      imgContainer.onmousemove = null;
      imgContainer.onmouseup = null;
      return;
  }
};

// S.2 Увеличивает размер изображения по нажатию на +
(function () {
  var photoPreview = document.querySelector('.img-upload__preview');
  var imgPreview = photoPreview.querySelector('img');
  var divHidden = photoPreview.querySelector('div');
  var zoomOutButton = document.querySelector('.scale__control--bigger');
  var zoomInButton = document.querySelector('.scale__control--smaller');
  var zoomStorage = document.querySelector('.scale__control--value');
  var imgContainer = document.querySelector('#imgContainer');

  var zoomInHandler = function () {
    var newValaue = parseInt(zoomStorage.value, 10) + window.ADD_PHOTO_RULES.ZOOM.STEP;
    zoomStorage.value = newValaue + '%';

    var scaleValue = newValaue / 100;
    imgPreview.style = 'transform: scale(' + scaleValue + ')';
    divHidden.style = 'overflow: auto';
    // divHidden.style добавлен, так как без него изображение при зуме
    // выскакивает из контейнера. Поэтому я добавил в html доп. div и
    // ему присваиваю стиль, который скрывает излишки изображения и
    // показывает скролл внутри

    if (scaleValue > 1) { // если масштаб более 100 то передаем флаг и включаем таскание
      dragImg(true);
      imgContainer.classList.add('all-scroll'); // добавляем правильный стиль курсора
    }

    if (parseInt(zoomStorage.value, 10) === window.ADD_PHOTO_RULES.ZOOM.MAX) {
      zoomOutButton.disabled = true;
    }

    if (parseInt(zoomStorage.value, 10) > window.ADD_PHOTO_RULES.ZOOM.MIN) {
      zoomInButton.disabled = false;
    }
  };

  zoomOutButton.addEventListener('click', zoomInHandler); // закртывается слушатешль
})(); // закрывают самовызов.

// S.2 Уменьшает размер изображения по нажатию на -
(function () {
  var photoPreview = document.querySelector('.img-upload__preview');
  var imgPreview = photoPreview.querySelector('img');
  var zoomInButton = document.querySelector('.scale__control--smaller');
  var zoomOutButton = document.querySelector('.scale__control--bigger');
  var zoomStorage = document.querySelector('.scale__control--value');
  var imgContainer = document.querySelector('#imgContainer');

  var zoomOutHandler = function () {
    var newValaue = parseInt(zoomStorage.value, 10) - window.ADD_PHOTO_RULES.ZOOM.STEP;
    zoomStorage.value = newValaue + '%';

    var scaleValue = newValaue / 100;
    imgPreview.style = 'transform: scale(' + scaleValue + ')';

    imgContainer.addEventListener('mousedown', function (evt) {
      evt.preventDefault();
    }); // вытаски

    if (scaleValue === 1) { // если масштаб равен 100 то передаем флаг и ВЫКЛЮЧАЕМ таскание
      dragImg(false);
      imgContainer.classList.remove('all-scroll');
    }

    if (parseInt(zoomStorage.value, 10) === window.ADD_PHOTO_RULES.ZOOM.MIN) {
      zoomInButton.disabled = true;
    }
    if (parseInt(zoomStorage.value, 10) < window.ADD_PHOTO_RULES.ZOOM.MAX) {
      zoomOutButton.disabled = false;
    }
  };

  zoomInButton.addEventListener('click', zoomOutHandler); // закртывается слушатешль
})(); // закрывают самовызов.